require.config({baseUrl:"lib",paths:{app:"..",jquery:["https://cdn.bootcss.com/jquery/2.2.4/jquery.min","jquery-2.2.4.min"],bootstrap:["https://cdn.bootcss.com/bootstrap/3.3.6/js/bootstrap.min","bootstrap.min"],alasql:["https://cdn.bootcss.com/alasql/0.2.6/alasql.min","alasql","alasql.min"],purl:"purl",angular:["https://cdn.bootcss.com/angular.js/1.4.8/angular.min","angular","angular.min"],angular_route:["https://cdn.bootcss.com/angular.js/1.4.8/angular-route.min","angular-route","angular-route.min"],chart:["https://cdn.bootcss.com/Chart.js/2.5.0/Chart.min","Chart.min"],print_helper:"../js/print-helper",db:"../js/db",common:"../js/common",index:"../js/index",sales_itemList:"../html-parts/sales/sales-itemList",sales_plan:"../html-parts/sales/sales-plan",sales_customers:"../html-parts/sales/sales-customers",sales_contracts:"../html-parts/sales/sales-contracts",sales_contractDetail:"../html-parts/sales/sales-contractDetail",sales_contractForm:"../html-parts/sales/sales-contractForm",sales_createOrder:"../html-parts/sales/sales-createOrder",sales_orderList:"../html-parts/sales/sales-orderList",sales_orderDetail:"../html-parts/sales/sales-orderDetail",sales_orderArrange:"../html-parts/sales/sales-orderArrange",purchase_analysis:"../html-parts/purchase/purchase-analysis",purchase_createOrder:"../html-parts/purchase/purchase-createOrder",purchase_plan:"../html-parts/purchase/purchase-plan",purchase_realTimePurchase:"../html-parts/purchase/purchase-realTimePurchase",purchase_orderList:"../html-parts/purchase/purchase-orderList",purchase_orderDetail:"../html-parts/purchase/purchase-orderDetail",purchase_itemForm:"../html-parts/purchase/purchase-itemForm",purchase_addStock:"../html-parts/purchase/purchase-addStock",warehouse_warehouseRecordList:"../html-parts/warehouse/warehouse-warehouseRecordList",warehouse_warehouseEntryCreate:"../html-parts/warehouse/warehouse-warehouseEntryCreate",warehouse_warehouseEntryDetail:"../html-parts/warehouse/warehouse-warehouseEntryDetail",warehouse_inventoryInspection:"../html-parts/warehouse/warehouse-inventoryInspection",warehouse_stockDetail:"../html-parts/warehouse/warehouse-stockDetail",userTask:"../html-parts/userTask/userTask",report:"../html-parts/statistic/statistic-report",report_detail:"../html-parts/statistic/statistic-purchaseDetail",all:"../build/all"},shim:{bootstrap:{deps:["jquery"],exports:"bootstrap"},purl:{deps:["jquery"],exports:"purl"},lazyload:{deps:["jquery"],exports:"lazyload"},angular:{exports:"angular"},angular_route:{deps:["angular"]}}});var salesScript=["sales_itemList","sales_plan","sales_customers","sales_contracts","sales_contractDetail","sales_contractForm","sales_createOrder","sales_orderList","sales_orderDetail","sales_orderArrange"],purchaseScript=["purchase_analysis","purchase_createOrder","purchase_plan","purchase_realTimePurchase","purchase_orderList","purchase_orderDetail","purchase_itemForm","purchase_addStock"],reportScript=["report","report_detail"],warehouseScript=["warehouse_warehouseRecordList","warehouse_warehouseEntryCreate","warehouse_warehouseEntryDetail","warehouse_inventoryInspection","warehouse_stockDetail"];define("../require-config",function(){}),mainApp.controller("itemListCtrl",["$scope","$selectService",function(e,r){e.warehouseChoice=r.getWarehouseListWithAll(),e.classificationChoice=r.getClassificationListWithAll(),e.makerChoice=r.getMakerListWithAll(),e.q1=e.warehouseChoice[0],e.q2=e.classificationChoice[0],e.makerQuery=e.makerChoice[0],e.inputCode="",e.search=function(r){var t=(e.q1.warehouseId,e.q2.classificationId),a=e.inputCode,o=e.makerQuery.maker,s="SELECT item.id, kind.text, item.code, item.maker, item.detail, item.price, item.unit             FROM item             JOIN kind on kind.id = item.kind             WHERE item.code LIKE ?";s+="All"!=o?" AND item.maker = '"+o+"' ":"",s+=t?"AND kind.id = "+t+" ":"";var i=alasql(s,["%"+a+"%"]);e.records=i},e.search()}]),mainApp.controller("itemDetailCtrl",["$scope","$location",function(e,r){var t=parseInt(r.search().id),a="SELECT item.id, kind.text, item.code, item.maker, item.detail, item.price, item.unit         FROM item         JOIN kind on kind.id = item.kind         WHERE item.id = ?",o=alasql(a,[t])[0];e.itemInfo=o}]),define("sales_itemList",function(){}),mainApp.controller("salePlanCtrl",["$scope","$searchService",function(e,r){e.update=function(){},planCommon(e,"salesplan",r)}]),define("sales_plan",function(){}),mainApp.controller("customerCtrl",["$scope",function(e){e.customers=alasql("SELECT * FROM customer");for(var r=0;r<e.customers.length;r++)e.customers[r].sex=1==e.customers[r].sex?"Male":"Female"}]),mainApp.controller("customerFormCtrl",["$scope",function(e){e.sexes=[];var r={};r.value=1,r.text="Male";var t={};t.value=2,t.text="Female",e.sexes.push(r),e.sexes.push(t),e.sex=e.sexes[0];var a=DB.getNewId("customer");e.id=a,e.addCustomer=function(r){if(!(e.id&&e.name&&e.contact_person&&e.sex&&e.tel&&e.addr))return void showError("Please input all information.");var t="INSERT INTO customer VALUES(?,?,?,?,?,?)";alasql(t,[parseInt(e.id),e.name,e.contact_person,e.sex.value,e.tel,e.addr]),showSuccess("Add customer success!"),window.location="sales.html#/customers"}}]),define("sales_customers",function(){}),mainApp.controller("contractsCtrl",["$scope",function(e){e.searchType="All",e.state="All",e.customerName="",e.search=function(){var r="SELECT a.id as contractId, a.type as contractType,                 b.name as customerName, c.name as salesmanName,*                 FROM contract a JOIN customer b ON a.customer = b.id                 JOIN users c ON a.salesman = c.id                 WHERE b.name  LIKE ? ";r+="All"==e.searchType?"":" AND a.type = '"+e.searchType+"'",r+="All"==e.state?"":" AND a.state = '"+e.state+"'",r+=void 0==e.startTime?"":" AND a.delivery_time >= '"+e.startTime.toISOString().slice(0,10)+"' ",void 0!=e.endTime&&e.endTime.setHours(24),r+=void 0==e.endTime?"":" AND a.delivery_time <= '"+e.endTime.toISOString().slice(0,10)+"' ",e.contracts=alasql(r,["%"+e.customerName+"%"]);for(var t=0;t<e.contracts.length;t++)e.contracts[t].sign_time=new Date(e.contracts[t].sign_time).toLocaleString(),e.contracts[t].delivery_time=new Date(e.contracts[t].delivery_time).toLocaleString(),e.contracts[t].validity_time=new Date(e.contracts[t].validity_time).toLocaleString()},e.search()}]),define("sales_contracts",function(){}),mainApp.controller("contractDetailCtrl",["$scope","$location",function(e,r){var t=parseInt(r.search().id);e.contractId=t;var a="SELECT a.id as contractId, a.type as contractType, b.name as customerName, c.name as salesmanName,*                 FROM contract a JOIN customer b ON a.customer = b.id JOIN users c ON a.salesman = c.id                WHERE a.id = ?";e.contractInfo=alasql(a,[t])[0],e.contractInfo.sign_time=e.contractInfo.sign_time.slice(0,10),e.contractInfo.delivery_time=e.contractInfo.delivery_time.slice(0,10),e.contractInfo.validity_time=e.contractInfo.validity_time.slice(0,10),a="SELECT item.id, kind.text, item.code, item.maker, item.detail, item.price, item.unit, contract_item.amount FROM contract_item             JOIN item ON contract_item.item_id = item.id            JOIN kind ON item.kind = kind.id            WHERE contract_id = ?",e.items=alasql(a,[e.contractId]),a="SELECT a.sale_order_id as orderId, b.create_time, b.state, b.delivery             FROM sale_order_contract a             JOIN sale_orders b ON a.sale_order_id = b.id             WHERE a.contract_id = ? ",e.orderRecords=alasql(a,[e.contractId]),formatAllDate(e.orderRecords,"create_time");for(var o=0;o<e.orderRecords.length;o++){var s=alasql("SELECT * FROM users WHERE id = ?",[e.orderRecords[o].delivery]);s.length>0?e.orderRecords[o].delivery=s.name:e.orderRecords[o].delivery=""}e.addToSaleOrder=function(){var r=localStorage.getItem("saleOrderContracts")||"[]";if(r=JSON.parse(r),r.length>0){var t="SELECT customer FROM contract WHERE id = ?",a=alasql(t,[parseInt(r[0])])[0],o=alasql(t,[e.contractId])[0];if(a.customer!=o.customer)return void showError("One order can only have one customer!!")}for(var s=!0,i=0;i<r.length;i++)r[i]==e.contractId&&(s=!1);s?(r.push(e.contractId),localStorage.setItem("saleOrderContracts",JSON.stringify(r)),showSuccess("Add To Sale Order Success!"),window.location="#/createOrder"):showError("This Contract has been added.")}}]),define("sales_contractDetail",function(){}),mainApp.controller("contractFormCtrl",["$scope",function(e){var r={};r.text="once";var t={};t.text="periodic",e.contractTypes=[],e.contractTypes.push(r),e.contractTypes.push(t),e.contractId=DB.getNewId("contract"),e.customers=alasql("SELECT * FROM customer"),e.salesmen=alasql("SELECT * FROM users WHERE type = 'salesman'"),e.contractType=e.contractTypes[0],e.sign_time="",e.delivery_time="",e.periodic="0",e.validity_time="";var a="SELECT item.id, kind.text, item.code, item.maker, item.detail, item.price, item.unit FROM item             JOIN kind ON item.kind = kind.id";e.allItems=alasql(a);for(var o=0;o<e.allItems.length;o++)e.allItems[o].amount=0;e.chooseItems=[],e.updateChooseItems=function(){e.chooseItems=[];for(var r=0;r<e.allItems.length;r++)e.allItems[r].amount>0&&e.chooseItems.push(e.allItems[r])},e.editAmount=function(r){var t=$(r.currentTarget);editTd(t,function(r,a){if(a!=r)if(/^\d+$/.test(a)){t.html(a);var o=t.parents("tbody").find("tr"),s=t.parents("tr"),i=o.index(s);e.allItems[i].amount=parseInt(a),e.updateChooseItems(),e.$apply()}else showError("please input integer");else t.html(a)})},e.validDate=function(e){var r=new Date(e);return"Invalid Date"!=r.toString()},e.addContract=function(r){if(!(e.customer&&e.salesman&&e.contractType&&e.sign_time&&e.delivery_time&&e.periodic&&e.validity_time))return void showError("Please input all information.");if(!e.validDate(e.sign_time))return void showError("Sign time is invalid");if(!e.validDate(e.delivery_time))return void showError("Delivery time is invalid");if(!e.validDate(e.validity_time))return void showError("Validity time is invalid");if(!/^\d+$/.test(e.periodic))return void showError("Please input integer in periodic");if(0==e.chooseItems.length)return void showError("You must select at least one items in a contract");var t="INSERT INTO contract VALUES(?,?,?,?,?,?,?,?,?)";alasql(t,[DB.getNewId("contract"),e.customer.id,e.salesman.id,e.contractType.text,new Date(e.sign_time).toISOString(),new Date(e.delivery_time).toISOString(),e.periodic,new Date(e.validity_time).toISOString(),"valid"]);for(var a=0;a<e.chooseItems.length;a++){var t="INSERT INTO contract_item VALUES (?,?,?,?,?)",o=DB.getNewId("contract_item");alasql(t,[o,e.contractId,e.chooseItems[a].id,e.chooseItems[a].amount,e.chooseItems[a].price])}showSuccess("Add success."),window.location="#/"}}]),define("sales_contractForm",function(){}),mainApp.controller("createSalesOrderCtrl",["$scope","$rootScope",function(e,r){e.updatePage=function(){var r=localStorage.getItem("saleOrderContracts")||"[]",r=JSON.parse(r),t={};e.contractList=[],0==r.length?e.hasRecord=!0:e.hasRecord=!1;for(var a=0;a<r.length;a++){var o="SELECT a.id as contractId, a.type as contractType,                     b.name as customerName, c.name as salesmanName,*                     FROM contract a JOIN customer b ON a.customer = b.id                     JOIN users c ON a.salesman = c.id                     WHERE a.id = ?",s=alasql(o,[parseInt(r[a])])[0];s.sign_time=s.sign_time.slice(0,10),s.delivery_time=s.delivery_time.slice(0,10),s.validity_time=s.validity_time.slice(0,10),e.contractList.push(s),o="SELECT item.id, kind.text, item.code, item.maker,                 item.detail, item.price, item.unit, contract_item.amount FROM contract_item                 JOIN item ON contract_item.item_id = item.id                JOIN kind ON item.kind = kind.id                WHERE contract_id = ?";for(var i=alasql(o,[parseInt(r[a])]),n=0;n<i.length;n++)void 0==t[i[n].id]?t[i[n].id]=i[n].amount:t[i[n].id]=t[i[n].id]+i[n].amount}e.items=[];for(var c=Object.keys(t),a=0;a<c.length;a++){var o="SELECT item.id, kind.text, item.code, item.maker, item.detail, item.price, item.unit                 FROM item                 JOIN kind on kind.id = item.kind                 WHERE item.id = ?",d=alasql(o,[parseInt(c[a])])[0];d.amount=t[c[a]],e.items.push(d)}},e.updatePage(),e.removeContract=function(r,t){for(var a=localStorage.getItem("saleOrderContracts")||"[]",a=JSON.parse(a),o=[],s=0;s<a.length;s++)a[s]!=t&&o.push(a[s]);return localStorage.setItem("saleOrderContracts",JSON.stringify(o)),e.updatePage(),r.preventDefault(),r.stopPropagation(),!1},e.createSaleOrder=function(){var t="INSERT INTO sale_orders VALUES(?,?,?,?,?,?);",a=DB.getNewId("sale_orders"),o=new Date;alasql(t,[a,o.toISOString(),"create","sale",e.contractList[0].customer,0]);for(var s=JSON.parse(localStorage.getItem("saleOrderContracts")||"[]"),i=0;i<s.length;i++)t="INSERT INTO sale_order_contract VALUES(?,?,?)",alasql(t,[DB.getNewId("sale_order_contract"),a,s[i]]);t="INSERT INTO sale_order_item VALUES(?,?,?,?,?)";for(var i=0;i<e.items.length;i++){var n=DB.getNewId("sale_order_item");alasql(t,[n,a,e.items[i].id,e.items[i].amount,e.items[i].price])}t="INSERT INTO orderoperation VALUES(?,?,?,?,?);",alasql(t,[DB.getNewId("orderoperation"),a,r.user.id,"create",(new Date).toISOString()]),localStorage.setItem("saleOrderContracts","[]"),showSuccess("Create sales order success!"),e.updatePage(),window.location="#/"}}]),define("sales_createOrder",function(){}),mainApp.controller("salesOrderListCtrl",["$scope",function(e){e.states=["All","create","Paid","Arranged","Warehouse Exiting","Delivered","Finished"],e.state="All",e.customerName="",e.search=function(){var r="SELECT a.id as orderId, b.name as customerName, * FROM sale_orders a ";r+="JOIN customer b ON a.customer = b.id ",r+="WHERE b.name LIKE ? ",r+="All"==e.state?"":" AND a.state = '"+e.state+"'",r+=void 0==e.startTime?"":" AND a.create_time >= '"+e.startTime.toISOString()+"' ",void 0!=e.endTime&&e.endTime.setHours(24),r+=void 0==e.endTime?"":" AND a.create_time <= '"+e.endTime.toISOString()+"' ",e.orderList=alasql(r,["%"+e.customerName+"%"]);for(var t=0;t<e.orderList.length;t++){e.orderList[t].create_time=e.orderList[t].create_time.slice(0,10);var a=e.orderList[t].delivery;r="SELECT * FROM users WHERE id = ?";var o=alasql(r,[a]);o.length>0&&(e.orderList[t].deliveryName=o[0].name)}},e.search(),e.goToArrange=function(e){window.location=$(e.currentTarget).attr("href"),e.preventDefault(),e.stopPropagation()}}]),define("sales_orderList",function(){}),mainApp.controller("salesOrderDetailCtrl",["$scope","$rootScope","$location","$searchService",function(e,r,t,a){var o=parseInt(t.search().id);e.orderId=o,e.steps=["create","Paid","Arranged","Warehouse Exiting","Delivered","Finished"],e.lines=[1,2,3,4,5],e.gap=95/(e.steps.length-1),e.updateOrderInfor=function(){var r="SELECT a.id as orderId, b.name as customerName,                      * FROM sale_orders a                     JOIN customer b ON a.customer = b.id                     WHERE a.id = ?";e.order=alasql(r,[e.orderId]),formatAllDate(e.order,"create_time"),e.order=e.order[0],e.deliveryId=e.order.delivery,deliveryInfo=alasql("SELECT * FROM users WHERE id = ?",[e.order.delivery]),deliveryInfo.length>0?e.order.delivery=deliveryInfo[0].name:e.order.delivery="",e.nowStep=0,e.stepColors=[];for(var t=0;t<e.steps.length;t++)e.order.state==e.steps[t]&&(e.nowStep=t);for(var t=0;t<e.steps.length;t++)t<=e.nowStep?e.stepColors.push("#DD0000"):e.stepColors.push("#bbb")},e.updateOrderInfor(),e.updateOperations=function(){sql="SELECT * FROM orderoperation                 JOIN users ON orderoperation.operator = users.id                 WHERE order_id = ?",e.operations=alasql(sql,[e.orderId]);for(var r=0;r<e.operations.length;r++)if(e.operations[r].operation.startsWith("Warehouse Exit")){var t=e.operations[r].operation.split("=")[1];t=t.slice(0,-1),e.operations[r].href="#/warehouseEntryDetail?id="+t+"&type=Exit"}formatAllDate(e.operations,"operation_time")},e.updateOperations(),e.getContractList=function(){var r=alasql("SELECT * FROM sale_order_contract WHERE sale_order_id = ?",[e.orderId]);e.contractList=[];for(var t=0;t<r.length;t++){var a="SELECT a.id as contractId, a.type as contractType,                             b.name as customerName, c.name as salesmanName,*                             FROM contract a JOIN customer b ON a.customer = b.id                             JOIN users c ON a.salesman = c.id                             WHERE a.id = ?",o=alasql(a,[parseInt(r[t].contract_id)])[0];o.sign_time=o.sign_time.slice(0,10),o.delivery_time=o.delivery_time.slice(0,10),o.validity_time=o.validity_time.slice(0,10),e.contractList.push(o)}},e.getContractList(),e.getOperationSumAmount=function(e,r,t){for(var a="SELECT * FROM warehouse_in_out a                     JOIN warehouse_in_out_item b ON a.id = b.in_out_id                     JOIN trans c ON b.trans_id = c.id                     WHERE a.order_id = ? AND c.stock = ? AND a.type = ? ",o=alasql(a,[e,r,t]),s=0,i=0;i<o.length;i++)s+=parseInt(o[i].qty);return s},e.updateItems=function(){var r="SELECT item.id as item_id, kind.text, item.code, item.maker, item.detail, item.price, item.unit,* FROM sale_order_item                 JOIN item ON sale_order_item.item_id = item.id                 JOIN kind ON item.kind = kind.id                 WHERE sale_order_item.sale_order_id = ?";e.totalPrice=0,e.items=alasql(r,[e.orderId]);for(var t=0;t<e.items.length;t++){var r="SELECT * FROM sale_order_item                         WHERE sale_order_id = ?                         AND item_id = ?",a=alasql(r,[e.orderId,e.items[t].item_id])[0],r="SELECT * FROM sale_order_stock WHERE sale_order_item_id = ?",o=alasql(r,[a.id]);e.items[t].arrangedAmount=0,e.items[t].exitWarehouseAmount=0;for(var s=0;s<o.length;s++)e.items[t].arrangedAmount+=parseInt(o[s].amount),e.items[t].exitWarehouseAmount+=-e.getOperationSumAmount(e.orderId,o[s].stock_id,"Exit");e.totalPrice+=e.items[t].amount*e.items[t].price}},e.updateItems(),e.showArrangeResult=function(){var r="SELECT sale_order_stock.stock_id, sale_order_stock.amount FROM sale_order_item                     JOIN sale_order_stock ON sale_order_item.id = sale_order_stock.sale_order_item_id                     WHERE sale_order_item.sale_order_id = ?",t=alasql(r,[e.orderId]);console.log(t);for(var o={},s=0;s<t.length;s++){var i=a.getStockInformation(t[s].stock_id);void 0==o[i.name]&&(o[i.name]={},o[i.name].data=[]),i.amount=t[s].amount,i.exitAmount=-e.getOperationSumAmount(e.orderId,t[s].stock_id,"Exit"),i.finished=i.exitAmount>=i.amount,o[i.name].data.push(i)}e.planDisplay=o,0==Object.keys(e.planDisplay)?e.hasArrange=!1:e.hasArrange=!0},e.showArrangeResult(),e.changeOrderState=function(t){var a="UPDATE sale_orders SET state = ? WHERE id = ?";alasql(a,[t,e.orderId]),a="INSERT INTO orderoperation VALUES(?,?,?,?,?);",alasql(a,[DB.getNewId("orderoperation"),e.orderId,r.user.id,t,(new Date).toISOString()]),showSuccess("This order is "+t+" successfully."),e.updateOrderInfor(),e.updateOperations()},e.payOrder=function(){e.changeOrderState("Paid")},e.deliveredOrder=function(){e.changeOrderState("Delivered")},e.finishOrder=function(){e.changeOrderState("Finished")},e.printThis=function(e){$(e.currentTarget).parents(".panel").find(".panel-body").jqprint()}}]),define("sales_orderDetail",function(){}),mainApp.controller("orderArrangeCtrl",["$scope","$location","$searchService","$rootScope",function(e,r,t,a){var o=parseInt(r.search().id);e.orderId=o;var s="SELECT a.id as orderId, b.name as customerName,                  * FROM sale_orders a                 JOIN customer b ON a.customer = b.id                 WHERE a.id = ?";e.order=alasql(s,[e.orderId])[0],e.updateItems=function(){var r="SELECT item.id as item_id, kind.text, item.code, item.maker, item.detail, item.price, item.unit,* FROM sale_order_item                 JOIN item ON sale_order_item.item_id = item.id                 JOIN kind ON item.kind = kind.id                 WHERE sale_order_item.sale_order_id = ?";e.items=alasql(r,[e.orderId]),e.arrangedStocks=[];for(var t=0;t<e.items.length;t++){var r="SELECT * FROM sale_order_item                         WHERE sale_order_id = ?                         AND item_id = ?",a=alasql(r,[e.orderId,e.items[t].item_id])[0],r="SELECT * FROM sale_order_stock WHERE sale_order_item_id = ?",o=alasql(r,[a.id]);e.items[t].arrangedAmount=0;for(var s=0;s<o.length;s++)e.items[t].arrangedAmount+=parseInt(o[s].amount),e.arrangedStocks.push(o[s])}},e.updateItems(),e.getSubmittedArrangedAmount=function(e){for(var r="SELECT c.amount, * FROM sale_orders a                     JOIN sale_order_item b ON a.id = b.sale_order_id                     JOIN sale_order_stock c ON b.id = c.sale_order_item_id                     WHERE a.state = ? AND c.stock_id = ?",t=alasql(r,["Arranged",e]),a=0,o=0;o<t.length;o++)a+=t[o].amount;return a},e.deliveryMen=alasql("SELECT * FROM users WHERE type = 'delivery'"),e.stocks=[],e.choosedItemId=0,e.arrange=function(r,t){e.choosedItemId=t.item_id;var a="SELECT stock.id, whouse.name, kind.text, item.code, item.maker, item.detail, item.price, stock.balance, item.unit, stock.warning_line             FROM stock             JOIN whouse ON whouse.id = stock.whouse             JOIN item ON item.id = stock.item             JOIN kind ON kind.id = item.kind             WHERE item.id = ?";e.stocks=alasql(a,[t.item_id]);for(var o=0;o<e.stocks.length;o++){var a="SELECT * FROM sale_order_item                     WHERE sale_order_id = ?                     AND item_id = ?",s=alasql(a,[e.orderId,e.choosedItemId])[0],a="SELECT * FROM sale_order_stock WHERE sale_order_item_id = ? AND stock_id = ?",i=alasql(a,[s.id,e.stocks[o].id]);e.stocks[o].arrangeAmount=0==i.length?0:i[0].amount,e.stocks[o].submittedArrangedAmount=e.getSubmittedArrangedAmount(e.stocks[o].id)}$("#selectStockModal").modal("show"),console.log(r),console.log(t)},e.showArrangeResult=function(){var r="SELECT sale_order_stock.stock_id, sale_order_stock.amount FROM sale_order_item                     JOIN sale_order_stock ON sale_order_item.id = sale_order_stock.sale_order_item_id                     WHERE sale_order_item.sale_order_id = ?",a=alasql(r,[e.orderId]);console.log(a);for(var o={},s=0;s<a.length;s++){var i=t.getStockInformation(a[s].stock_id);void 0==o[i.name]&&(o[i.name]={},o[i.name].data=[]),i.amount=a[s].amount,o[i.name].data.push(i)}e.planDisplay=o,0==Object.keys(e.planDisplay)?e.hasArrange=!1:e.hasArrange=!0},e.showArrangeResult(),e.confirm=function(r){for(var t="SELECT * FROM sale_order_item                     WHERE sale_order_id = ?                     AND item_id = ?",a=alasql(t,[e.orderId,e.choosedItemId])[0],o=0,s=0;s<e.stocks.length;s++){if(o+=parseInt(e.stocks[s].arrangeAmount),e.stocks[s].arrangeAmount>e.stocks[s].balance)return void showError("Arrange amount can not over the stock's balance.");if(e.stocks[s].arrangeAmount<0)return void showError("Arrange amount can not input negative number")}if(o>a.amount)return void showError("The sum of the amount can not over the item's amount.");for(var s=0;s<e.stocks.length;s++)if(e.stocks[s].submittedArrangedAmount+parseInt(e.stocks[s].arrangeAmount)>e.stocks[s].balance)return void showError("The Stock in line "+(s+1)+" exceed stock balance");for(var s=0;s<e.stocks.length;s++){var t="SELECT * FROM sale_order_stock WHERE sale_order_item_id = ? AND stock_id = ?",i=alasql(t,[a.id,e.stocks[s].id]);e.stocks[s].arrangeAmount>0?i.length>0?alasql("UPDATE sale_order_stock SET amount = ? WHERE sale_order_item_id = ? AND stock_id = ?",[e.stocks[s].arrangeAmount,a.id,e.stocks[s].id]):alasql("INSERT INTO sale_order_stock VALUES(?,?,?,?)",[DB.getNewId("sale_order_stock"),a.id,e.stocks[s].id,parseInt(e.stocks[s].arrangeAmount)]):i.length>0&&alasql("DELETE FROM sale_order_stock WHERE sale_order_item_id = ? AND stock_id = ?",[a.id,e.stocks[s].id])}e.showArrangeResult(),e.updateItems(),$("#selectStockModal").modal("hide")},e.confirmEnterKey=function(r){"Enter"==r.key&&e.confirm(r)},e.submitArrangeOrder=function(){if(void 0==e.deliveryMan)return void showError("Please Select a delivery man.");for(var r=!0,o=0;o<e.items.length;o++)if(e.items[o].amount!=e.items[o].arrangedAmount){r=!1;break}if(0==r)return void showError("Please arrange all the items before submit.");for(var o=0;o<e.arrangedStocks.length;o++){var s=e.getSubmittedArrangedAmount(e.arrangedStocks[o].stock_id),i=t.getStockInformation(e.arrangedStocks[o].stock_id);if(s+e.arrangedStocks[o].amount>i.balance)return showError("The arranged stock("+i.detail+" in "+i.name+") has exceed its balance, Please check"),!1}var n="UPDATE sale_orders SET state = ? WHERE id = ?";alasql(n,["Arranged",e.orderId]);var n="UPDATE sale_orders SET delivery = ? WHERE id = ?";alasql(n,[e.deliveryMan.id,e.orderId]),n="INSERT INTO orderoperation VALUES(?,?,?,?,?);",alasql(n,[DB.getNewId("orderoperation"),e.orderId,a.user.id,"Arranged",(new Date).toISOString()]),showSuccess("This order arrangement submit success."),window.location="#/orderList"}}]),define("sales_orderArrange",function(){}),mainApp.controller("analysisCtrl",["$scope","$selectService","$searchService",function(e,r,t){e.warehouseChoice=r.getWarehouseListWithAll(),e.classificationChoice=r.getClassificationListWithAll(),e.q1=e.warehouseChoice[0],e.q2=e.classificationChoice[0],e.inputCode="",null!=localStorage.getItem("purchaseItems")&&""!=localStorage.getItem("purchaseItems")||localStorage.setItem("purchaseItems","{}"),e.purchaseItems=JSON.parse(localStorage.getItem("purchaseItems")),e.search=function(r){for(var a=e.q1.warehouseId,o=e.q2.classificationId,s=e.inputCode,i=t.searchStockInformation(a,o,s),n=0;n<i.length;n++){var c=e.purchaseItems[i[n].stock_id];c=void 0==c?0:c,i[n].balance+c<i[n].warning_line?i[n].backgroundColor="red":i[n].backgroundColor="white"}e.records=i},e.search(),e.addToProcurement=function(r){var t=$(r.currentTarget).parents("tr").attr("data-href").split("=")[1];console.log(t);var a=JSON.parse(localStorage.getItem("purchaseItems"));return void 0==a[t]?a[t]=1:a[t]=a[t]+1,e.purchaseItems=a,localStorage.setItem("purchaseItems",JSON.stringify(a)),e.search(),r.preventDefault(),r.stopPropagation(),!1},e.removeFromProcurement=function(r){var t=$(r.currentTarget).parents("tr").attr("data-href").split("=")[1];console.log(t);var a=JSON.parse(localStorage.getItem("purchaseItems"));if(void 0!=a[t])return a[t]>1?a[t]=a[t]-1:1==a[t]&&delete a[t],e.purchaseItems=a,localStorage.setItem("purchaseItems",JSON.stringify(a)),e.search(),r.preventDefault(),r.stopPropagation(),!1}}]),define("purchase_analysis",function(){}),mainApp.controller("ordersCtrl",["$scope","$rootScope","$searchService",function(e,r,t){e.updatePlanDisplay=function(){var r={};null!=localStorage.getItem("purchaseItems")&&""!=localStorage.getItem("purchaseItems")||localStorage.setItem("purchaseItems","{}");for(var a=JSON.parse(localStorage.getItem("purchaseItems")),o=Object.keys(a),s=0;s<o.length;s++){var i=t.getStockInformation(parseInt(o[s]));i.chooseAmount=a[o[s]],void 0==r[i.maker]&&(r[i.maker]={},r[i.maker].data=[],r[i.maker].total=0),r[i.maker].data.push(i),r[i.maker].total+=i.price*i.chooseAmount}o=Object.keys(r);for(var n=0,s=0;s<o.length;s++)n+=r[o[s]].total;e.costTotal=n,console.log(r),e.planDisplay=r,e.hasRecord=0==Object.keys(r).length},e.updatePlanDisplay(),e.addToProcurement=function(r){var t=$(r.currentTarget).parents("tr").attr("data-href").split("=")[1];console.log(t);var a=JSON.parse(localStorage.getItem("purchaseItems")||"{}");void 0==a[t]?a[t]=1:a[t]=a[t]+1,e.purchaseItems=a,localStorage.setItem("purchaseItems",JSON.stringify(a)),e.updatePlanDisplay()},e.removeFromProcurement=function(r){var t=$(r.currentTarget).parents("tr").attr("data-href").split("=")[1];console.log(t);var a=JSON.parse(localStorage.getItem("purchaseItems")||"{}");void 0!=a[t]&&(a[t]>1?a[t]=a[t]-1:1==a[t]&&delete a[t],e.purchaseItems=a,localStorage.setItem("purchaseItems",JSON.stringify(a)),e.updatePlanDisplay())},e.createOrder=function(){var t=DB.getNewId("orders"),a="INSERT INTO orders VALUES(?,?,?,?);",o=new Date;alasql(a,[t,o.toISOString(),"create","purchase"]);for(var s=JSON.parse(localStorage.getItem("purchaseItems")||"{}"),i=Object.keys(s),n=0;n<i.length;n++){var c=DB.getNewId("orderstock");a="INSERT INTO orderstock VALUES(?,?,?,?,?);",alasql(a,[c,t,parseInt(i[n]),parseInt(s[i[n]]),0])}var c=DB.getNewId("orderoperation");a="INSERT INTO orderoperation VALUES(?,?,?,?,?);",alasql(a,[c,t,r.user.id,"create",o.toISOString()]),localStorage.setItem("purchaseItems","{}"),showSuccess("A new purchase order has been created."),e.updatePlanDisplay(),setTimeout('window.location="#/"',1e3)},e.changeChooseAmount=function(r){(null==r.chooseAmount||void 0==r.chooseAmount||parseInt(r.chooseAmount)<0)&&(r.chooseAmount=1);var t=JSON.parse(localStorage.getItem("purchaseItems")||"{}");t[r.id]=parseInt(r.chooseAmount),0==parseInt(r.chooseAmount)&&(delete t[r.id],localStorage.setItem("purchaseItems",JSON.stringify(t)),e.updatePlanDisplay()),localStorage.setItem("purchaseItems",JSON.stringify(t))},e.editAmount=function(r){var t=$(r.currentTarget);editTd(t,function(r,a){if(a!=r)if(/^\d+$/.test(a)){t.html(a);var o=t.parents("tr").attr("data-href").split("=")[1],s=JSON.parse(localStorage.getItem("purchaseItems")||"{}");s[o]=parseInt(a),0==parseInt(a)&&delete s[o],localStorage.setItem("purchaseItems",JSON.stringify(s)),e.updatePlanDisplay(),e.$apply()}else showError("please input integer");else t.html(a)})}}]),define("purchase_createOrder",function(){}),mainApp.controller("purchasePlanCtrl",["$scope","$searchService",function(e,r){e.holdingCost=0,e.orderCost=0,e.perPrice=0,e.update=function(){e.totalCost=0;for(var r=0,t=0;t<e.monthlyPlan.length;t++)r+=e.monthlyPlan[t].planValue-e.saleMonthlyPlan[t].planValue,e.totalCost+=parseInt(e.holdingCost)*(r<0?0:r),e.totalCost+=parseInt(e.monthlyPlan[t].planValue)*parseInt(e.perPrice),e.totalCost+=parseInt(e.monthlyPlan[t].planValue)>0?parseInt(e.orderCost):0;e.totalCost=e.totalCost<0?0:e.totalCost},planCommon(e,"purchaseplan",r)}]),define("purchase_plan",function(){}),mainApp.controller("createPurchaseOrderCtrl",["$scope","$searchService",function(e,r){e.year="2017",e.month=((new Date).getMonth()+1).toString(),e.readFromDataBase=function(){var t="SELECT * FROM purchaseplan WHERE month = ? and plan_value > 0",a=alasql(t,[parseInt(e.month)]);e.candidatePurchaseOrder=[];for(var o=0;o<a.length;o++){var s=r.getStockInformation(a[o].stock_id),i={};i.warehouse=s.name,i.code=s.code,i.maker=s.maker,i.detail=s.detail,i.realStock=s.balance,i.purchasePlan=a[o].plan_value,i.stock_id=a[o].stock_id,i.planStock=r.calculateExpectStock(a[o].stock_id,e.year,e.month),i.purchaseCount=Math.max(0,a[o].plan_value+i.planStock-i.realStock),e.candidatePurchaseOrder.push(i)}},e.readFromDataBase(),e.itemChange=function(){e.readFromDataBase()},e.editPurchaseCount=function(r){var t=$(r.currentTarget);editTd(t,function(r,a){if(a!=r)if(/^\d+$/.test(a)){t.html(a);var o=t.parents("tbody").find("tr"),s=t.parents("tr"),i=o.index(s);e.candidatePurchaseOrder[i].purchaseCount=parseInt(a),e.$apply()}else showError("please input integer");else t.html(a)})},e.addToPurchaseOrder=function(){for(var r=JSON.parse(localStorage.getItem("purchaseItems")||"{}"),t=0;t<e.candidatePurchaseOrder.length;t++){var a=e.candidatePurchaseOrder[t].stock_id,o=e.candidatePurchaseOrder[t].purchaseCount;o>0&&(r[a]=o)}localStorage.setItem("purchaseItems",JSON.stringify(r)),showSuccess("Import to purchase order success!"),window.location="#/createOrder"}}]),define("purchase_realTimePurchase",function(){}),mainApp.controller("orderListCtrl",["$scope",function(e){e.states=["All","create","Confirmed Purchase Price","Paid","Warehouse Entering","Finished"],e.state="All",e.search=function(){e.orderList=[];var r="SELECT * FROM orders WHERE type = 'purchase' ";r+="All"==e.state?"":'AND state = "'+e.state+'" ',r+=void 0==e.startTime?"":" AND create_time >= '"+e.startTime.toISOString()+"' ",void 0!=e.endTime&&e.endTime.setHours(24),
r+=void 0==e.endTime?"":" AND create_time <= '"+e.endTime.toISOString()+"' ",r+=" ORDER BY id DESC";for(var t=alasql(r),a=0;a<t.length;a++){var o={};o.orderId=t[a].id,o.createTime=new Date(t[a].create_time).toLocaleString(),o.state=t[a].state,r="SELECT * FROM orderoperation JOIN users ON orderoperation.operator = users.id WHERE orderoperation.order_id = ? and orderoperation.operation = ?";var s=alasql(r,[o.orderId,"create"])[0];o.createPerson=s.name,e.orderList.push(o)}},e.search(),e.detail=function(e){}}]),define("purchase_orderList",function(){}),mainApp.controller("orderDetailCtrl",["$scope","$rootScope","$location","$searchService",function(e,r,t,a){var o=parseInt(t.search().id);e.orderId=o;var s="SELECT * FROM orders WHERE id = ?";e.order=alasql(s,[e.orderId])[0],e.steps=["create","Confirmed Purchase Price","Paid","Warehouse Entering","Finished"],e.lines=[1,2,3,4],e.gap=95/(e.steps.length-1),e.updateOperations=function(){var r="SELECT * FROM orderoperation a JOIN users b ON a.operator = b.id WHERE a.order_id = ?";e.operations=alasql(r,[e.orderId]);for(var t=0;t<e.operations.length;t++)e.operations[t].operation_time=new Date(e.operations[t].operation_time).toLocaleString();for(var t=0;t<e.operations.length;t++)if(e.operations[t].operation.startsWith("Warehouse Entry")){var a=e.operations[t].operation.split("=")[1];a=a.slice(0,-1),e.operations[t].href="#/warehouseEntryDetail?id="+a+"&type=Entry"}e.nowStep=0,e.stepColors=[];for(var t=0;t<e.steps.length;t++)e.order.state==e.steps[t]&&(e.nowStep=t);for(var t=0;t<e.steps.length;t++)t<=e.nowStep?e.stepColors.push("#DD0000"):e.stepColors.push("#bbb")},e.getOperationSumAmount=function(e,r,t){for(var a="SELECT * FROM warehouse_in_out a                     JOIN warehouse_in_out_item b ON a.id = b.in_out_id                     JOIN trans c ON b.trans_id = c.id                     WHERE a.order_id = ? AND c.stock = ? AND a.type = ? ",o=alasql(a,[e,r,t]),s=0,i=0;i<o.length;i++)s+=parseInt(o[i].qty);return s},e.updatePlanDisplay=function(){for(var r={},t=0,o="SELECT * FROM orderstock WHERE order_id = "+e.orderId,s=alasql(o),i=0;i<s.length;i++){s[i].stock_id,s[i].amount;var n=a.getStockInformation(s[i].stock_id);n.chooseAmount=s[i].amount,void 0==r[n.maker]&&(r[n.maker]={},r[n.maker].data=[],r[n.maker].total=0),n.purchasePrice=s[i].purchase_price||0,n.receivedAmount=e.getOperationSumAmount(e.orderId,s[i].stock_id,"Entry"),n.finished=n.receivedAmount>=n.chooseAmount,r[n.maker].data.push(n),r[n.maker].total+=n.price*n.chooseAmount,t+=n.purchasePrice*n.chooseAmount}e.planDisplay=r,e.totalCost=t,e.updateOperations()},e.updatePlanDisplay(),e.deleteOrder=function(){var r="DELETE FROM orders WHERE id = ?",t="DELETE FROM orderstock WHERE order_id = ?",a="DELETE FROM orderoperation WHERE order_id = ?";alasql(r,[e.orderId]),alasql(t,[e.orderId]),alasql(a,[e.orderId]),showSuccess("This order is deleted success."),window.location="purchase.html#/orderList"},e.confirmOrder=function(){for(var t=Object.keys(e.planDisplay),a=0;a<t.length;a++)for(var o=e.planDisplay[t[a]].data,s=0;s<o.length;s++)if(row=o[s],!row.purchasePrice)return void showError("Please input all purchase price.");var i='UPDATE orders SET state = "Confirmed Purchase Price" WHERE id = ?';alasql(i,[e.orderId]);var n=DB.getNewId("orderoperation"),c=new Date;i="INSERT INTO orderoperation VALUES(?,?,?,?,?);",alasql(i,[n,e.orderId,r.user.id,"Confirmed Purchase Price",c.toISOString()]),showSuccess("This purchase is submitted successfully.");var i="SELECT * FROM orders WHERE id = ?";e.order=alasql(i,[e.orderId])[0],e.updateOperations()},e.payOrder=function(){var t='UPDATE orders SET state = "Paid" WHERE id = ?';alasql(t,[e.orderId]);var a=DB.getNewId("orderoperation"),o=new Date;t="INSERT INTO orderoperation VALUES(?,?,?,?,?);",alasql(t,[a,e.orderId,r.user.id,"Paid",o.toISOString()]),showSuccess("This purchase is paid successfully.");var t="SELECT * FROM orders WHERE id = ?";e.order=alasql(t,[e.orderId])[0],e.updateOperations()},e.finishOrder=function(){for(var t=Object.keys(e.planDisplay),a=0;a<t.length;a++)for(var o=e.planDisplay[t[a]].data,s=0;s<o.length;s++)if(row=o[s],!row.finished)return void showError("You can not finish this order before warehouse receive all items.");var i="UPDATE orders SET state = 'Finished' WHERE id = ? ";alasql(i,[e.orderId]),i="INSERT INTO orderoperation VALUES(?,?,?,?,?);",alasql(i,[DB.getNewId("orderoperation"),e.orderId,r.user.id,"Finished",(new Date).toISOString()]),showSuccess("This order is finished successfully.");var i="SELECT * FROM orders WHERE id = ?";e.order=alasql(i,[e.orderId])[0],e.updateOperations()},e.editPurchasePrice=function(r){var t=$(r.currentTarget);editTd(t,function(r,o){if(o!=r)if(/^\d+$/.test(o)){t.html(o);var s=t.parents("tbody").find("tr"),i=t.parents("tr"),n=s.index(i),c=parseInt(i.attr("data-href").split("=")[1]),d=a.getStockInformation(c);e.planDisplay[d.maker].data[n].purchasePrice=parseInt(o);var l="UPDATE orderstock set purchase_price = "+parseInt(o)+" WHERE order_id = ? AND stock_id = ?";alasql(l,[e.orderId,d.id]),e.$apply()}else showError("please input integer");else t.html(o)})},e.priceChange=function(r){(null==r.purchasePrice||void 0==r.purchasePrice||parseInt(r.purchasePrice)<0)&&(r.purchasePrice=0);var t="UPDATE orderstock SET purchase_price = "+r.purchasePrice+" WHERE order_id = ? AND stock_id = ?";alasql(t,[e.orderId,r.id]),e.updatePlanDisplay()},e.printThis=function(e){$(e.currentTarget).parents(".panel").find(".panel-body").jqprint()}}]),define("purchase_orderDetail",function(){}),mainApp.controller("itemFormCtrl",["$scope",function(e){var r="SELECT * FROM kind";e.kinds=alasql(r),r="SELECT maker FROM item GROUP BY maker",e.makers=alasql(r),e.price=0,e.unit="Pcs",e.kindChange=function(){var r="SELECT * FROM item WHERE kind = ? ORDER BY code DESC",t=alasql(r,[e.chooseKind.id]);t=t||[],0==t.length?e.code=e.chooseKind.text+"01":(code=t[0].code,e.code=code.slice(0,-1)+(parseInt(code.slice(-1))+1))},e.addItem=function(r){if(!(e.chooseKind&&e.code&&e.maker&&e.detail&&e.price&&e.unit))return void showError("Please input all information.");var t=DB.getNewId("item"),a="INSERT INTO item VALUES(?,?,?,?,?,?,?)";alasql(a,[t,e.code,e.chooseKind.id,e.detail,e.maker.maker,parseInt(e.price),e.unit]),showSuccess("Add Item Success")}}]),define("purchase_itemForm",function(){}),mainApp.controller("addStockCtrl",["$scope","$selectService","$searchService",function(e,r,t){e.warehouseChoice=r.getWarehouseList(),e.itemList=r.getItemList(),e.warehouse=e.warehouseChoice[0],e.item=e.itemList[0],e.time=new Date,e.update=function(){var r=alasql("SELECT id, balance FROM stock WHERE whouse = ? AND item = ?",[e.warehouse.warehouseId,e.item.id]);r.length>0?e.nowInStock=r[0].balance:e.nowInStock=0},e.update(),e.submit=function(){if(!(e.warehouse&&e.item&&e.time&&e.quantity&&e.comment))return void showError("Please input the necessary fields.");var r=e.warehouse.warehouseId,a=e.item.id,o=parseInt(e.quantity),s=e.time,i=e.comment,n=t.editStockRecord(r,a,o,s,i);return!!n&&(showSuccess("Change stock success!"),$("#update").attr("disabled","disabled"),void setTimeout("window.location.assign('#/allStocks');",1e3))}}]),define("purchase_addStock",function(){}),mainApp.controller("purchaseReportCtrl",["$scope","$location","$searchService",function(e,r,t){e.class=r.search().class,e.show="purchase"==e.class||"sales"==e.class,e.show||(e.class="purchase"),e.titleName="sales"==e.class?"Sales":"Purchase",e.period="Monthly",e.monthNames=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];var a=new Date;e.year=a.getFullYear().toString(),e.month=(a.getMonth()+1).toString(),e.monthName="",e.reportType="amount",e.allPurchaseRecords,e.allSalesRecords,e.getAllRecords=function(){var r="SELECT * FROM orders                     JOIN orderstock ON orders.id = orderstock.order_id                     WHERE orders.state = 'Finished'";e.allPurchaseRecords=alasql(r);var r="SELECT b.amount as itemAmount, c.amount as stockAmount, * FROM sale_orders a                     JOIN sale_order_item b ON a.id = b.sale_order_id                     JOIN sale_order_stock c ON b.id = c.sale_order_item_id                     WHERE a.state = 'Finished' ";e.allSalesRecords=alasql(r)},e.getAllRecords(),e.searchInMem=function(r,t,a,o,s,i){var n;n="purchase"==i?e.allPurchaseRecords:e.allSalesRecords;for(var c=[],d=0;d<n.length;d++){var l=n[d];l.create_time>=o.toISOString()&&l.create_time<=s.toISOString()&&l.stock_id==r&&c.push(n[d])}return c},e.getOneMonthPurchaseAmount=function(r,t,a,o,s){var i="SELECT * FROM orders                     JOIN orderstock ON orders.id = orderstock.order_id                     WHERE orders.state = 'Finished'";i+=" AND orders.create_time >= '"+o.toISOString()+"'",i+=" AND orders.create_time <= '"+s.toISOString()+"'",i+=" AND orderstock.stock_id = "+r;for(var n=e.searchInMem(r,t,a,o,s,"purchase"),c=0,d=0,l=0;l<n.length;l++)c+=n[l].amount,d+=n[l].amount*n[l].purchase_price;return[c,d]},e.getOneMonthSalesAmount=function(r,t,a,o,s){var i="SELECT b.amount as itemAmount, c.amount as stockAmount, * FROM sale_orders a                     JOIN sale_order_item b ON a.id = b.sale_order_id                     JOIN sale_order_stock c ON b.id = c.sale_order_item_id                     WHERE a.state = 'Finished' ";i+=" AND a.create_time >= '"+o.toISOString()+"'",i+=" AND a.create_time <= '"+s.toISOString()+"'",i+=" AND c.stock_id = "+r;for(var n=e.searchInMem(r,t,a,o,s,"sales"),c=0,d=0,l=0;l<n.length;l++)c+=n[l].stockAmount,d+=n[l].stockAmount*n[l].price;return[c,d]},e.getOneMonthAmount=function(r,t,a){r=parseInt(r),t=parseInt(t),a=parseInt(a);var o=new Date(""+a+"/01/"+t);if(a<12)s=new Date(""+(a+1)+"/01/"+t);else var s=new Date("01/01/"+(t+1));return"sales"==e.class?e.getOneMonthSalesAmount(r,t,a,o,s):e.getOneMonthPurchaseAmount(r,t,a,o,s)},e.search=function(){e.monthName=e.monthNames[parseInt(e.month)-1];for(var r="SELECT stock.id, whouse.name, kind.text, item.code, item.maker,                 item.detail, item.price, stock.balance, item.unit, stock.warning_line                 FROM stock                 JOIN whouse ON whouse.id = stock.whouse                 JOIN item ON item.id = stock.item                 JOIN kind ON kind.id = item.kind",a=alasql(r),o=t.getAllPlanValue("purchaseplan"),s=0;s<a.length;s++){var i=t.getPlanValueFromAll("purchaseplan",a[s].id,e.year,e.month,o);a[s].planAmount=i.plan_value;var n=e.getOneMonthAmount(a[s].id,e.year,e.month);a[s].realPurchaseAmount=n[0],a[s].totalCost=n[1],a[s].yearAmount=[],a[s].yearCost=[];for(var c=0;c<e.monthNames.length;c++){var n=e.getOneMonthAmount(a[s].id,e.year,c+1);a[s].yearAmount.push(n[0]),a[s].yearCost.push(n[1])}}e.stocks=a},e.search(),e.printThis=function(e){$(e.currentTarget).parents(".panel").find(".panel-body").jqprint()},e.generateCsvByTalbe=function(e){for(var r="",t=$(e),a=t.find("tr"),o=0;o<a.length;o++){for(var s=$(a[o]),i=s.find("td,th"),n="",c=0;c<i.length;c++)n+=$(i[c]).text(),n+=c<i.length-1?",":"\n";r+=n}return r},e.export=function(r,t){var a=$(r.currentTarget).parents(".panel").find(".panel-body").find(".table"),o=e.generateCsvByTalbe(a),s="report";"Monthly"==t?s="MonthlyReport-"+e.monthName+"-"+e.year:"YearlyAmount"==t?s="YearlyAmountReport-"+e.year:"YearlyCost"==t?s="YearlyCostReport-"+e.year:"YearlyIncome"==t&&(s="YearlyIncomeReport-"+e.year),FILE.doSave(o,"text/csv",s+".csv")}}]),define("report",function(){}),mainApp.controller("statisticPurchaseDetailCtrl",["$scope","$location","$searchService",function(e,r,t){e.period=r.search().period,e.year=r.search().year,e.month=r.search().month,e.stock_id=r.search().stock_id,e.class=r.search().class,e.monthNames=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"],e.getMonthPurchaseStock=function(e,r,a){var o,e=parseInt(e),r=parseInt(r),a=parseInt(a),s=new Date(""+a+"/01/"+r);o=a<12?new Date(""+(a+1)+"/01/"+r):new Date("01/01/"+(r+1));var i="SELECT * FROM orders                     JOIN orderstock ON orders.id = orderstock.order_id                     WHERE orders.state = 'Finished'";i+=" AND orders.create_time >= '"+s.toISOString()+"'",i+=" AND orders.create_time <= '"+o.toISOString()+"'",i+=" AND orderstock.stock_id = "+e;for(var n=alasql(i),c=[],d=0,l=0,u=0;u<n.length;u++)c.push(t.getStockInformation(n[u].stock_id)),c[u].orderId=n[u].order_id,c[u].price=n[u].purchase_price,c[u].amount=n[u].amount,c[u].time=new Date(n[u].create_time).toLocaleString(),d+=n[u].amount,l+=n[u].amount*n[u].purchase_price;return[d,l,c]},e.monthlyPurchase=function(){e.title="Detail Monthly Purchase Records For Stock "+e.stock_id+" in "+e.monthNames[parseInt(e.month)-1]+" "+e.year;var r=e.getMonthPurchaseStock(e.stock_id,e.year,e.month);e.sumAmount=r[0],e.totalCost=r[1],e.stocks=r[2]},e.getMonthSaleStock=function(e,r,a){var o,e=parseInt(e),r=parseInt(r),a=parseInt(a),s=new Date(""+a+"/01/"+r);o=a<12?new Date(""+(a+1)+"/01/"+r):new Date("01/01/"+(r+1));var i="SELECT b.amount as itemAmount, c.amount as stockAmount, a.id as sale_order_id,* FROM sale_orders a                     JOIN sale_order_item b ON a.id = b.sale_order_id                     JOIN sale_order_stock c ON b.id = c.sale_order_item_id                     WHERE a.state = 'Finished' ";i+=" AND a.create_time >= '"+s.toISOString()+"'",i+=" AND a.create_time <= '"+o.toISOString()+"'",i+=" AND c.stock_id = "+e;for(var n=alasql(i),c=[],d=0,l=0,u=0;u<n.length;u++)c.push(t.getStockInformation(n[u].stock_id)),c[u].orderId=n[u].sale_order_id,c[u].price=n[u].price,c[u].amount=n[u].stockAmount,c[u].time=new Date(n[u].create_time).toLocaleString(),d+=n[u].stockAmount,l+=n[u].stockAmount*n[u].price;return[d,l,c]},e.monthlySales=function(){e.title="Detail Monthly Sales Records For Stock "+e.stock_id+" in "+e.monthNames[parseInt(e.month)-1]+","+e.year;var r=e.getMonthSaleStock(e.stock_id,e.year,e.month);e.sumAmount=r[0],e.totalCost=r[1],e.stocks=r[2]},e.yearlyPurchase=function(){e.title="Detail Yearly Purchase Records For Stock "+e.stock_id+" in "+e.year,e.sumAmount=0,e.totalCost=0,e.stocks=[],e.monthStocks=[],e.monthSumAmount=[],e.monthTotalCost=[];for(var r=1;r<=12;r++){var t=e.getMonthPurchaseStock(e.stock_id,e.year,r);e.sumAmount+=t[0],e.totalCost+=t[1],e.monthSumAmount.push(t[0]),e.monthTotalCost.push(t[1]);for(var a=t[2],o=0;o<a.length;o++)e.stocks.push(a[o]);e.monthStocks.push(a)}},e.yearlySales=function(){e.title="Detail Yearly Sales Records For Stock "+e.stock_id+" in "+e.year,e.sumAmount=0,e.totalCost=0,e.stocks=[],e.monthStocks=[],e.monthSumAmount=[],e.monthTotalCost=[];for(var r=1;r<=12;r++){var t=e.getMonthSaleStock(e.stock_id,e.year,r);e.sumAmount+=t[0],e.totalCost+=t[1],e.monthSumAmount.push(t[0]),e.monthTotalCost.push(t[1]);for(var a=t[2],o=0;o<a.length;o++)e.stocks.push(a[o]);e.monthStocks.push(a)}},"Monthly"==e.period&&"purchase"==e.class?e.monthlyPurchase():"Monthly"==e.period&&"sales"==e.class?e.monthlySales():"Yearly"==e.period&&"purchase"==e.class?e.yearlyPurchase():"Yearly"==e.period&&"sales"==e.class&&e.yearlySales(),e.printThis=function(e){$(e.currentTarget).parents(".panel").find(".panel-body").jqprint()},e.generateCsvByTalbe=function(r){for(var t="",a=$(r),o=a.find("tr"),s="",i=0;i<o.length;i++){var n=$(o[i]),c=n.find("td,th"),d="";9==c.length&&"Yearly"==e.period&&(d+=s+",");for(var l=0;l<c.length;l++)10==c.length&&0==l?(s=$(c[l]).text().trim().replace(/:\s+/g,":").split(/\s+/g)[0],d+='"'+s+'"'):d+='"'+$(c[l]).text()+'"',d+=l<c.length-1?",":"\n";t+=d}return t},e.export=function(r,t){var a=$(r.currentTarget).parents(".panel").find(".panel-body").find(".table"),o=e.generateCsvByTalbe(a),s="report";s=e.title,FILE.doSave(o,"text/csv",s+".csv")}}]),define("report_detail",function(){}),mainApp.controller("warehouseRecordListCtrl",["$scope","$rootScope","$location","$selectService",function(e,r,t,a){e.searchType=t.search().type,e.show="Entry"==e.searchType||"Exit"==e.searchType,e.searchOrderId="",e.warehouseChoice=a.getWarehouseListWithAll(),e.q1=e.warehouseChoice[0],"warehouse"==r.user.type&&(e.q1=e.warehouseChoice[r.user.belong_warehouse],$("#q1").attr("disabled","disabled")),e.search=function(){var r="SELECT a.id as recordId,c.name as whouse_name, * FROM warehouse_in_out as a                     JOIN users as b ON a.keeper_id = b.id                     JOIN whouse as c ON a.whouse_id = c.id                     WHERE 1 = 1 ",t=e.q1.warehouseId;r+=t?" AND a.whouse_id = "+t+" ":"",r+=e.show?" AND a.type = '"+e.searchType+"'":"",r+=e.searchOrderId&&e.searchOrderId.trim()?" AND a.order_id = "+e.searchOrderId:"",r+=void 0==e.startTime?"":" AND a.entry_time >= '"+e.startTime.toISOString()+"' ",void 0!=e.endTime&&e.endTime.setHours(24),r+=void 0==e.endTime?"":" AND a.entry_time <= '"+e.endTime.toISOString()+"' ",e.records=alasql(r);for(var a=0;a<e.records.length;a++)e.records[a].entry_time=new Date(e.records[a].entry_time).toLocaleString()},e.search(),e.addNew=function(r){"Entry"==e.searchType?window.location="warehouse.html#/purchaseOrderList":"Exit"==e.searchType&&(window.location="warehouse.html#/salesOrderList")}}]),define("warehouse_warehouseRecordList",function(){}),mainApp.controller("warehouseEntryCreateCtrl",["$scope","$rootScope","$location","$searchService",function(e,r,t,a){e.orderId=parseInt(t.search().id),e.maker=t.search().maker||t.search().warehouse,e.createType=t.search().type,e.initEntryData=function(){var t="SELECT * FROM orders WHERE id = ?";e.order=alasql(t,[e.orderId])[0];for(var o={},t="SELECT * FROM orderstock WHERE order_id = "+e.orderId,s=alasql(t),i=0;i<s.length;i++){s[i].stock_id,s[i].amount;var n=a.getStockInformation(s[i].stock_id);n.chooseAmount=s[i].amount,void 0==o[n.maker]&&(o[n.maker]={},o[n.maker].data=[],o[n.maker].total=0),n.receiveAmount=0,n.purchasePrice=s[i].purchase_price||0,r.user.warehouse_name==n.name&&(o[n.maker].data.push(n),o[n.maker].total+=n.price*n.chooseAmount)}e.planDisplay=o},e.initExitData=function(){e.warehouse=e.maker;var r="SELECT * FROM sale_orders WHERE id = ?";e.order=alasql(r,[e.orderId])[0];var t={};r="SELECT b.stock_id, b.amount FROM sale_order_item a                 JOIN sale_order_stock b ON a.id = b.sale_order_item_id                 WHERE a.sale_order_id = ?";for(var o=alasql(r,[e.orderId]),s=0;s<o.length;s++){o[s].stock_id,o[s].amount;var i=a.getStockInformation(o[s].stock_id);i.chooseAmount=o[s].amount,i.exitAmount=0,i.name==e.warehouse&&(void 0==t[i.name]&&(t[i.name]={},t[i.name].data=[],t[i.name].total=0),t[i.name].data.push(i))}e.planDisplay=t},"Exit"==e.createType?e.initExitData():"Entry"==e.createType?e.initEntryData():e.initEntryData(),e.submitEntryOrder=function(){var t=e.planDisplay[e.maker].data,a=DB.getNewId("warehouse_in_out"),o="INSERT INTO warehouse_in_out VALUES (?,?,?,?,?,?);",s=new Date;alasql(o,[a,e.orderId,s.toISOString(),r.user.id,"Entry",r.user.belong_warehouse]);for(var i=0;i<t.length;i++){var n=t[i];o="SELECT * FROM stock WHERE id = ?";var c=alasql(o,[n.id])[0].balance,d=parseInt(c)+parseInt(n.receiveAmount),l=DB.getNewId("trans"),u="INSERT INTO trans VALUES (?,?,?,?,?,?);";alasql(u,[l,n.id,(new Date).toISOString(),parseInt(n.receiveAmount),d,"purchased"]);var m=DB.getNewId("warehouse_in_out_item"),o="INSERT INTO warehouse_in_out_item VALUES (?,?,?);";alasql(o,[m,a,l]),o="UPDATE stock SET balance = ? WHERE id = ?",alasql(o,[d,n.id])}var o="INSERT INTO orderoperation VALUES(?,?,?,?,?);";alasql(o,[DB.getNewId("orderoperation"),e.orderId,r.user.id,"Warehouse Entry (id="+a+")",(new Date).toISOString()]),o="UPDATE orders SET state = ? WHERE id = ?",alasql(o,["Warehouse Entering",e.orderId]),showSuccess("Add Warehouse Entry records success"),window.location="#/"},e.submitExitOrder=function(){for(var t=e.planDisplay[e.warehouse].data,a=0;a<t.length;a++){var o=t[a];if(o.balance<o.exitAmount)return void showError("The Exit Count can not bigger than the stock count");if(o.exitAmount<0)return void showError("The Exit Count can not less than zero!");if(!/^\d+$/.test(o.exitAmount))return void showError("Please input integer!")}var s=DB.getNewId("warehouse_in_out"),i="INSERT INTO warehouse_in_out VALUES (?,?,?,?,?,?);",n=new Date;alasql(i,[s,e.orderId,n.toISOString(),r.user.id,"Exit",r.user.belong_warehouse]);for(var a=0;a<t.length;a++){var o=t[a];if(!(o.exitAmount<=0)){i="SELECT * FROM stock WHERE id = ?";var c=alasql(i,[o.id])[0].balance,d=parseInt(c)-parseInt(o.exitAmount),l=DB.getNewId("trans"),u="INSERT INTO trans VALUES (?,?,?,?,?,?);";alasql(u,[l,o.id,(new Date).toISOString(),-parseInt(o.exitAmount),d,"Sold"]);var m=DB.getNewId("warehouse_in_out_item"),i="INSERT INTO warehouse_in_out_item VALUES (?,?,?);";alasql(i,[m,s,l]),i="UPDATE stock SET balance = ? WHERE id = ?",alasql(i,[d,o.id])}}var i="INSERT INTO orderoperation VALUES(?,?,?,?,?);";alasql(i,[DB.getNewId("orderoperation"),e.orderId,r.user.id,"Warehouse Exit (id="+s+")",(new Date).toISOString()]),i="UPDATE sale_orders SET state = ? WHERE id = ?",alasql(i,["Warehouse Exiting",e.orderId]),showSuccess("Add Warehouse Exit records success"),window.location="#/"},e.submitOrder=function(){"Entry"==e.createType?e.submitEntryOrder():"Exit"==e.createType?e.submitExitOrder():showError("The type is not right")},e.verifyReceiveAmount=function(e){(null==e.receiveAmount||void 0==e.receiveAmount||e.receiveAmount<0)&&(e.receiveAmount=0)},e.verifyExitAmount=function(e){(null==e.exitAmount||void 0==e.exitAmount||e.exitAmount<0)&&(e.exitAmount=0)}}]),define("warehouse_warehouseEntryCreate",function(){}),mainApp.controller("warehouseEntryDetailCtrl",["$scope","$location","$searchService",function(e,r,t){e.recordId=parseInt(r.search().id),e.createType=r.search().type,e.recordInfo=alasql("SELECT * FROM warehouse_in_out WHERE id = ?",[e.recordId])[0],e.recordInfo.entry_time=new Date(e.recordInfo.entry_time).toLocaleString(),e.recordInfo.name=alasql("SELECT * FROM users WHERE id = ?",[e.recordInfo.keeper_id])[0].name;var a="SELECT * FROM warehouse_in_out_item a                     JOIN trans b ON a.trans_id = b.id                     WHERE a.in_out_id = ?",o=alasql(a,[e.recordId]);e.initEntryData=function(){for(var r={},a=0;a<o.length;a++){var s=t.getStockInformation(o[a].stock);e.maker=s.maker,void 0==r[s.maker]&&(r[s.maker]={},r[s.maker].data=[],r[s.maker].total=0),s.receiveAmount=o[a].qty,r[s.maker].data.push(s),r[s.maker].total+=s.price*s.chooseAmount}e.planDisplay=r},e.initExitData=function(){for(var r={},a=0;a<o.length;a++){var s=t.getStockInformation(o[a].stock);e.maker=s.name,void 0==r[s.name]&&(r[s.name]={},r[s.name].data=[],r[s.name].total=0),s.exitAmount=-o[a].qty,r[s.name].data.push(s)}e.planDisplay=r},e.init=function(){"Entry"==e.createType?e.initEntryData():"Exit"==e.createType&&e.initExitData()},e.init()}]),define("warehouse_warehouseEntryDetail",function(){}),mainApp.controller("inventoryInspectionCtrl",["$scope","$rootScope","$selectService",function(e,r,t){e.warehouseChoice=t.getWarehouseListWithAll(),e.classificationChoice=t.getClassificationListWithAll(),e.q1=e.warehouseChoice[0],e.q2=e.classificationChoice[0],e.inputCode="",null!=localStorage.getItem("purchaseItems")&&""!=localStorage.getItem("purchaseItems")||localStorage.setItem("purchaseItems","{}"),e.purchaseItems=JSON.parse(localStorage.getItem("purchaseItems")),"warehouse"==r.user.type&&(e.q1=e.warehouseChoice[r.user.belong_warehouse],$("#q1").attr("disabled","disabled")),e.search=function(){var r=e.q1.warehouseId,t=e.q2.classificationId,a=e.inputCode,o="SELECT stock.id, whouse.name, kind.text, item.code, item.maker,             item.detail, item.price, stock.balance, item.unit, stock.warning_line             FROM stock             JOIN whouse ON whouse.id = stock.whouse             JOIN item ON item.id = stock.item             JOIN kind ON kind.id = item.kind             WHERE item.code LIKE ?";o+=r?"AND whouse.id = "+r+" ":"",o+=t?"AND kind.id = "+t+" ":"";for(var s=alasql(o,["%"+a+"%"]),i=0;i<s.length;i++)s[i].balance<s[i].warning_line?s[i].backgroundColor="red":s[i].backgroundColor="white";e.records=s},e.search()}]),define("warehouse_inventoryInspection",function(){}),mainApp.controller("stockDetailCtrl",["$scope","$location","$searchService",function(e,r,t){var a=parseInt(r.search().id),o=t.getStockInformation(a);e.stockInfo=o,e.trans=alasql("SELECT * FROM trans WHERE stock = ?",[a]);for(var s=0;s<e.trans.length;s++)e.trans[s].date=new Date(e.trans[s].date).toLocaleString();e.editWarningLine=function(r){var t=$(r.currentTarget);editTd(t,function(r,a){if(a!=r)if(/^\d+$/.test(a)){t.html(a);var o="UPDATE stock SET warning_line = ? WHERE id = ?";alasql(o,[parseInt(a),e.stockInfo.id]),e.$apply()}else showError("please input integer");else t.html(a)})},e.updateWarningLine=function(r){var t="UPDATE stock SET warning_line = ? WHERE id = ?";alasql(t,[e.stockInfo.warning_line,e.stockInfo.id]),showSuccess("Update warning line success")},e.updateEnterKey=function(r){"Enter"==r.key&&e.updateWarningLine(r)}}]),define("warehouse_stockDetail",function(){}),mainApp.controller("userTaskCtrl",["$scope","$rootScope","$searchService",function(e,r,t){e.replaceDeliveryName=function(e){if(void 0!=e&&null!=e&&0!=e.length)for(var r=0;r<e.length;r++){e[r].create_time=e[r].create_time.slice(0,10);var t=e[r].delivery,a="SELECT * FROM users WHERE id = ?",o=alasql(a,[t]);o.length>0&&(e[r].deliveryName=o[0].name)}},e.searchForDelivery=function(){e.saleOrderList=[];var t="SELECT a.id as orderId, b.name as customerName, * FROM sale_orders a                 JOIN customer b ON a.customer = b.id                 WHERE (a.state = 'Warehouse Exiting' OR a.state = 'Arranged')                 AND a.delivery = "+r.user.id;e.saleOrderList=alasql(t),e.replaceDeliveryName(e.saleOrderList)},e.dealWithPurchaseOrders=function(r){e.purchaseOrderList=[];for(var t=[],a=0;a<r.length;a++){var o={};o.orderId=r[a].id,o.createTime=new Date(r[a].create_time).toLocaleString(),o.state=r[a].state,sql="SELECT * FROM orderoperation JOIN users ON orderoperation.operator = users.id WHERE orderoperation.order_id = ? and orderoperation.operation = ?";var s=alasql(sql,[o.orderId,"create"])[0];o.createPerson=s.name,t.push(o)}return t},e.searchForFinancial=function(){e.purchaseOrderList=[];var r="SELECT a.id as orderId, b.name as customerName, * FROM sale_orders a                 JOIN customer b ON a.customer = b.id                 WHERE a.state = 'create'";e.saleOrderList=alasql(r),e.replaceDeliveryName(e.saleOrderList);var r="SELECT * FROM orders WHERE type = 'purchase' AND state = 'Confirmed Purchase Price'",t=alasql(r);e.purchaseOrderList=e.dealWithPurchaseOrders(t)},e.getOperationSumAmount=function(e,r,t){for(var a="SELECT * FROM warehouse_in_out a                     JOIN warehouse_in_out_item b ON a.id = b.in_out_id                     JOIN trans c ON b.trans_id = c.id                     WHERE a.order_id = ? AND c.stock = ? AND a.type = ? ",o=alasql(a,[e,r,t]),s=0,i=0;i<o.length;i++)s+=parseInt(o[i].qty);return s},e.isFinished=function(r){for(var a=!0,o="SELECT * FROM orderstock WHERE order_id = "+r,s=alasql(o),i=0;i<s.length;i++){var n=t.getStockInformation(s[i].stock_id);if(n.chooseAmount=s[i].amount,n.receivedAmount=e.getOperationSumAmount(r,s[i].stock_id,"Entry"),n.finished=n.receivedAmount>=n.chooseAmount,!n.finished){a=!1;break}}return a},e.addToProcurement=function(r){var t=$(r.currentTarget).parents("tr").attr("data-href").split("=")[1];console.log(t);var a=JSON.parse(localStorage.getItem("purchaseItems"));return void 0==a[t]?a[t]=1:a[t]=a[t]+1,e.purchaseItems=a,localStorage.setItem("purchaseItems",JSON.stringify(a)),e.searchForBuyer(),r.preventDefault(),r.stopPropagation(),!1},e.removeFromProcurement=function(r){var t=$(r.currentTarget).parents("tr").attr("data-href").split("=")[1];console.log(t);var a=JSON.parse(localStorage.getItem("purchaseItems"));if(void 0!=a[t])return a[t]>1?a[t]=a[t]-1:1==a[t]&&delete a[t],e.purchaseItems=a,localStorage.setItem("purchaseItems",JSON.stringify(a)),e.searchForBuyer(),r.preventDefault(),r.stopPropagation(),!1},e.searchShortageStock=function(){for(var r="SELECT stock.id as stock_id, whouse.name, kind.text, item.code, item.maker,             item.detail, item.price, stock.balance, item.unit, stock.warning_line,whouse.id as w_id             FROM stock             JOIN whouse ON whouse.id = stock.whouse             JOIN item ON item.id = stock.item             JOIN kind ON kind.id = item.kind             WHERE stock.balance < stock.warning_line ",t=alasql(r),a=0;a<t.length;a++){e.purchaseItems=JSON.parse(localStorage.getItem("purchaseItems")||"[]");var o=e.purchaseItems[t[a].stock_id];o=void 0==o?0:o,t[a].balance+o<t[a].warning_line?t[a].backgroundColor="red":t[a].backgroundColor="white"}e.shortageStocks=t},e.searchForBuyer=function(){e.waitingPricePurchaseOrderList=[],e.warehouseEnteringOrder=[],e.shortageStocks=[];var r="SELECT * FROM orders WHERE type = 'purchase' AND state = 'create' ",t=alasql(r);e.waitingPricePurchaseOrderList=e.dealWithPurchaseOrders(t),r="SELECT * FROM orders WHERE type = 'purchase' AND (state = 'Warehouse Entering' OR state = 'Confirmed Purchase Price' OR state = 'Paid') ",t=alasql(r),e.warehouseEnteringOrder=e.dealWithPurchaseOrders(t);for(var a=0;a<e.warehouseEnteringOrder.length;a++)e.warehouseEnteringOrder[a].finished=e.isFinished(e.warehouseEnteringOrder[a].orderId),e.warehouseEnteringOrder[a].backgroundColor=e.warehouseEnteringOrder[a].finished?"#5CB85C":"#D9534F";e.searchShortageStock()},e.searchForSalesman=function(){e.waitingArrangeSaleOrderList=[];var r="SELECT a.id as orderId, b.name as customerName, * FROM sale_orders a                 JOIN customer b ON a.customer = b.id                 WHERE a.state = 'Paid' ";e.waitingArrangeSaleOrderList=alasql(r),e.replaceDeliveryName(e.waitingArrangeSaleOrderList),e.contracts=[];var r="SELECT a.id as contractId, a.type as contractType,                 b.name as customerName, c.name as salesmanName,*                 FROM contract a JOIN customer b ON a.customer = b.id                 JOIN users c ON a.salesman = c.id                 WHERE 1 = 1";e.contracts=alasql(r);for(var t=0;t<e.contracts.length;t++)e.contracts[t].sign_time=new Date(e.contracts[t].sign_time).toLocaleString(),e.contracts[t].delivery_time=new Date(e.contracts[t].delivery_time).toLocaleString(),e.contracts[t].validity_time=new Date(e.contracts[t].validity_time).toLocaleString();e.warehouseExitingOrderList=[];var r="SELECT a.id as orderId, b.name as customerName, * FROM sale_orders a                 JOIN customer b ON a.customer = b.id                 WHERE a.state = 'Arranged' OR a.state = 'Warehouse Exiting' OR a.state = 'Delivered'";e.warehouseExitingOrderList=alasql(r),e.replaceDeliveryName(e.warehouseExitingOrderList)},e.removeUncorrelatedPurchaseOrder=function(t){for(var a=[],o=0;o<t.length;o++){for(var s=t[o].id,i=!1,n="SELECT * FROM orderstock                         JOIN stock ON orderstock.stock_id = stock.id                         WHERE orderstock.order_id = ?                         AND stock.whouse = ?",c=alasql(n,[s,r.user.belong_warehouse]),d=0;d<c.length;d++){var l=e.getOperationSumAmount(s,c[d].stock_id,"Entry");if(l<c[d].amount){i=!0;break}}i&&a.push(t[o])}return a},e.removeUncorrelatedSalesOrder=function(t){for(var a=[],o=0;o<t.length;o++){for(var s=t[o].orderId,i=!1,n="SELECT * FROM sale_order_item a                         JOIN sale_order_stock b ON a.id = b.sale_order_item_id                         JOIN stock c ON b.stock_id = c.id                         WHERE a.sale_order_id = ?                         AND c.whouse = ?",c=alasql(n,[s,r.user.belong_warehouse]),d=0;d<c.length;d++){var l=-e.getOperationSumAmount(s,c[d].stock_id,"Exit");if(l<c[d].amount){i=!0;break}}i&&a.push(t[o])}return a},e.searchForWarehouse=function(){var t="SELECT * FROM orders WHERE type = 'purchase'                      AND (state = 'Warehouse Entering' OR state = 'Paid')";o=alasql(t),o=e.removeUncorrelatedPurchaseOrder(o),e.warehouseEnteringOrder=e.dealWithPurchaseOrders(o);for(var a=0;a<e.warehouseEnteringOrder.length;a++)e.warehouseEnteringOrder[a].finished=e.isFinished(e.warehouseEnteringOrder[a].orderId),
e.warehouseEnteringOrder[a].backgroundColor=e.warehouseEnteringOrder[a].finished?"#5CB85C":"#D9534F";e.warehouseExitingOrderList=[];var t="SELECT a.id as orderId, b.name as customerName, * FROM sale_orders a                 JOIN customer b ON a.customer = b.id                 WHERE a.state = 'Arranged' OR a.state = 'Warehouse Exiting' ",o=alasql(t);e.warehouseExitingOrderList=e.removeUncorrelatedSalesOrder(o),e.replaceDeliveryName(e.warehouseExitingOrderList),e.searchShortageStock();for(var s=[],a=0;a<e.shortageStocks.length;a++)e.shortageStocks[a].w_id==r.user.belong_warehouse&&s.push(e.shortageStocks[a]);e.shortageStocks=s},"delivery"==r.user.type?e.searchForDelivery():"financial"==r.user.type?e.searchForFinancial():"buyer"==r.user.type?e.searchForBuyer():"salesman"==r.user.type?e.searchForSalesman():"warehouse"==r.user.type&&e.searchForWarehouse()}]),define("userTask",function(){}),require(["../require-config","sales_itemList","sales_plan","sales_customers","sales_contracts","sales_contractDetail","sales_contractForm","sales_createOrder","sales_orderList","sales_orderDetail","sales_orderArrange","purchase_analysis","purchase_createOrder","purchase_plan","purchase_realTimePurchase","purchase_orderList","purchase_orderDetail","purchase_itemForm","purchase_addStock","report","report_detail","warehouse_warehouseRecordList","warehouse_warehouseEntryCreate","warehouse_warehouseEntryDetail","warehouse_inventoryInspection","warehouse_stockDetail","userTask"],function(){}),define("all-controller",function(){});